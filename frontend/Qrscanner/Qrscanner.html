<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ParkQueue - Admin</title>
  <link rel="icon" type="image/jpg" href="../../img/logow.png" />
  <link rel="stylesheet" href="../dashboard/dashboard.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .qr-scanner {
      padding: 25px;
      min-height: calc(100vh - 70px);
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid rgba(0, 0, 0, 0.1);
    }

    .page-title {
      font-size: 2rem;
      color: #333;
      font-weight: 600;
    }

    .page-subtitle {
      font-size: 1.2rem;
      color: #666;
      font-weight: 500;
      margin-top: 5px;
    }

    .scanner-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      height: calc(100vh - 180px);
    }

    .scanner-container-card,
    .user-container-card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .card-title {
      font-size: 1.5rem;
      color: #333;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title i {
      color: #1f8012;
    }

    .scanner-display {
      flex: 1;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }

    #qr-reader {
      width: 100% !important;
      height: 100% !important;
      position: relative !important;
    }

    .qr-attach-section {
      background: #f8f9fa;
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 25px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .qr-attach-section:hover {
      background: #e9ecef;
      border-color: #999;
    }

    .qr-attach-section.drag-over {
      background: #e3f2fd;
      border-color: #2196f3;
      border-style: solid;
    }

    .attach-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: #6c757d;
    }

    #fileInput {
      display: none;
    }

    .scanner-status {
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 6px;
      font-weight: 500;
      text-align: center;
      font-size: 0.95rem;
    }

    .status-scanning {
      background: rgba(31, 128, 18, 0.1);
      color: #1f8012;
      border: 1px solid rgba(31, 128, 18, 0.2);
    }

    .status-success {
      background: rgba(31, 128, 18, 0.2);
      color: #155724;
      border: 1px solid rgba(31, 128, 18, 0.3);
    }

    .status-error {
      background: rgba(220, 53, 69, 0.1);
      color: #dc3545;
      border: 1px solid rgba(220, 53, 69, 0.2);
    }

    .scanner-controls {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .scanner-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      flex: 1;
      font-size: 1rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: #1f8012;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #17690c;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .user-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #e0e0e0;
      display: none;
    }

    .user-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .user-avatar {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #1f8012 0%, #8f7d35 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.5rem;
      border: 3px solid white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .user-basic {
      flex: 1;
    }

    .user-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .user-email {
      color: #666;
      font-size: 0.9rem;
    }

    .user-status {
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      white-space: nowrap;
    }

    .status-approved {
      background: rgba(31, 128, 18, 0.1);
      color: #1f8012;
      border: 1px solid rgba(31, 128, 18, 0.2);
    }

    .status-pending {
      background: rgba(255, 193, 7, 0.1);
      color: #d39e00;
      border: 1px solid rgba(255, 193, 7, 0.2);
    }

    .user-details-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .detail-item {
      background: white;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }

    .detail-label {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .detail-value {
      font-weight: 500;
      color: #333;
      word-break: break-word;
    }

    .vehicle-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }

    .vehicle-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: #333;
    }

    .vehicle-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .action-btn {
      padding: 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 1rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-success {
      background: #1f8012;
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #17690c;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #c82333;
      transform: translateY(-2px);
    }

    .stats-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      border-color: #1f8012;
    }

    .stat-card.active {
      border-color: #1f8012;
      background: rgba(31, 128, 18, 0.05);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .stat-card--parking .stat-icon {
      background: linear-gradient(135deg, #1f8012, #4caf50);
    }

    .stat-card--occupied .stat-icon {
      background: linear-gradient(135deg, #2196f3, #03a9f4);
    }

    .stat-card--scans .stat-icon {
      background: linear-gradient(135deg, #ff9800, #ffb74d);
    }

    .stat-content h3 {
      margin: 0 0 8px 0;
      font-size: 0.95rem;
      font-weight: 500;
      color: #666;
    }

    .stat-value {
      margin: 0;
      font-size: 2rem;
      font-weight: 700;
      color: #222;
    }

    .parking-counter {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      border: 1px solid #e0e0e0;
      margin-bottom: 15px;
    }

    .parking-counter .counter-number {
      font-size: 3rem;
      color: #1f8012;
      margin-bottom: 5px;
    }

    .parking-counter .counter-total {
      font-size: 1rem;
      color: #666;
      margin-top: 5px;
    }

    .parking-status-info {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #e0e0e0;
    }

    .parking-status-info>div {
      text-align: center;
      flex: 1;
    }

    .parking-status-info .occupied-count {
      font-size: 1.2rem;
      font-weight: bold;
      color: #1f8012;
    }

    .parking-status-label {
      font-size: 0.85rem;
      color: #666;
    }

    .scan-counter {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      border: 1px solid #e0e0e0;
      margin-bottom: 20px;
    }

    .counter-number {
      font-size: 2.5rem;
      font-weight: bold;
      color: #1f8012;
      margin-bottom: 5px;
    }

    .counter-label {
      font-size: 0.95rem;
      color: #666;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: #666;
      font-size: 1rem;
    }

    .notification-container {
      position: fixed;
      top: 90px;
      right: 20px;
      z-index: 1000;
      max-width: 350px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .notification {
      padding: 15px 20px;
      border-radius: 8px;
      background: white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #1f8012;
      display: flex;
      align-items: center;
      justify-content: space-between;
      animation: slideIn 0.3s ease;
      transform: translateX(0);
      transition: all 0.3s ease;
    }

    .notification.hiding {
      transform: translateX(100%);
      opacity: 0;
    }

    .notification-success {
      border-left-color: #1f8012;
      background: linear-gradient(90deg, rgba(31, 128, 18, 0.1) 0%, white 100%);
    }

    .notification-error {
      border-left-color: #dc3545;
      background: linear-gradient(90deg, rgba(220, 53, 69, 0.1) 0%, white 100%);
    }

    .notification-warning {
      border-left-color: #ff9800;
      background: linear-gradient(90deg, rgba(255, 152, 0, 0.1) 0%, white 100%);
    }

    .notification-info {
      border-left-color: #2196f3;
      background: linear-gradient(90deg, rgba(33, 150, 243, 0.1) 0%, white 100%);
    }

    .notification-content {
      flex: 1;
      margin-right: 15px;
    }

    .notification-title {
      font-weight: 600;
      margin-bottom: 5px;
      color: #333;
    }

    .notification-message {
      font-size: 0.9rem;
      color: #666;
      line-height: 1.4;
    }

    .notification-close {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 1rem;
      padding: 5px;
      transition: color 0.2s;
    }

    .notification-close:hover {
      color: #333;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @media (max-width: 1200px) {
      .scanner-layout {
        grid-template-columns: 1fr;
        height: auto;
      }

      .stats-cards {
        grid-template-columns: repeat(2, 1fr);
      }

      .notification-container {
        top: 70px;
        right: 10px;
        left: 10px;
        max-width: none;
      }
    }

    @media (max-width: 768px) {
      .qr-scanner {
        padding: 20px;
      }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      .scanner-controls {
        flex-direction: column;
      }

      .action-buttons {
        grid-template-columns: 1fr;
      }

      .user-details-grid {
        grid-template-columns: 1fr;
      }

      .vehicle-info {
        grid-template-columns: 1fr;
      }

      .stats-cards {
        grid-template-columns: 1fr;
      }

      .parking-status-info {
        flex-direction: column;
        gap: 10px;
      }

      .notification-container {
        top: 60px;
        right: 10px;
        left: 10px;
      }

      .notification {
        padding: 12px 15px;
      }
    }
  </style>
</head>

<body>
  <nav class="top-navbar">
    <div class="navbar-left">
      <div class="navbar-brand">
        <h1 class="brand-title"><a href="../dashboard/dashboard.html">ParkQueue</a></h1>
      </div>
      <button id="menuToggle" class="menu-toggle" aria-label="Toggle menu" aria-expanded="false">
        <span class="burger-line"></span>
        <span class="burger-line"></span>
        <span class="burger-line"></span>
      </button>
    </div>

    <div class="navbar-right">
      <div class="navbar-stats">
        <div class="stat-item">
          <i class="fas fa-parking"></i>
          <span id="availableSlotsNav">0</span>
        </div>
        <div class="stat-item">
          <i class="fas fa-qrcode"></i>
          <span id="scansCountNav">0</span>
        </div>
      </div>

      <div class="date-display">
        <i class="fas fa-calendar-alt"></i>
        <span id="currentDate">Loading...</span>
      </div>

      <div class="admin-profile-dropdown">
        <button class="profile-toggle" id="profileToggle" aria-expanded="false">
          <div class="admin-avatar-small">
            <span id="adminInitialsNav">A</span>
          </div>
          <span class="admin-name-nav" id="adminNameNav">Loading...</span>
          <i class="fas fa-chevron-down"></i>
        </button>
        <div class="profile-dropdown-menu">
          <div class="dropdown-user-info">
            <div class="admin-avatar">
              <span id="adminInitials">A</span>
            </div>
            <div class="admin-details">
              <span id="adminName" class="admin-name">Loading...</span>
              <span id="adminEmail" class="admin-email">admin@example.com</span>
            </div>
          </div>
          <div class="dropdown-divider"></div>
          <a href="../dashboard/dashboard.html" class="dropdown-item">
            <i class="fas fa-chart-bar"></i> Dashboard
          </a>
          <a href="../account-management/account-management.html" class="dropdown-item">
            <i class="fas fa-users"></i> Account Management
          </a>
          <a href="../pendingApproval/approvals.html" class="dropdown-item active">
            <i class="fas fa-check-circle"></i> Pending Approvals
          </a>
          <a href="../qrscanner/qrscanner.html" class="dropdown-item">
            <i class="fas fa-qrcode"></i> QR Scanner
          </a>
          <a href="#" class="dropdown-item">
            <i class="fas fa-camera"></i> CCTV
          </a>
          <a href="../parking-history/parking-history.html" class="dropdown-item active">
            <i class="fas fa-history"></i> Parking History
          </a>
          <div class="dropdown-divider"></div>
          <button id="logoutBtn" class="dropdown-item logout-item">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>
    </div>
  </nav>

  <div id="mobileMenu" class="mobile-menu-overlay">
    <div class="mobile-menu-content">
      <div class="mobile-menu-header">
        <div class="mobile-admin-info">
          <div class="admin-avatar">
            <span id="mobileAdminInitials">A</span>
          </div>
          <div class="admin-details">
            <span id="mobileAdminName" class="admin-name">Loading...</span>
            <span id="mobileAdminEmail" class="admin-email">admin@example.com</span>
          </div>
        </div>
        <button class="close-menu" id="closeMenu">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <ul class="mobile-menu-items">
        <li class="mobile-menu-item">
          <a href="../dashboard/dashboard.html" class="mobile-menu-link">
            <i class="fas fa-chart-bar"></i> Dashboard
          </a>
        </li>
        <li class="mobile-menu-item">
          <a href="../account-management/account-management.html" class="mobile-menu-link">
            <i class="fas fa-users"></i> Account Management
          </a>
        </li>
        <li class="mobile-menu-item">
          <a href="../pendingApproval/approvals.html" class="mobile-menu-link">
            <i class="fas fa-check-circle"></i> Pending Approvals
          </a>
        </li>
        <li class="mobile-menu-item">
          <a href="../Qrscanner/Qrscanner.html" class="mobile-menu-link active">
            <i class="fas fa-qrcode"></i> QR Scanner
          </a>
        </li>
        <li class="mobile-menu-item">
          <a href="#" class="mobile-menu-link">
            <i class="fas fa-camera"></i> CCTV
          </a>
        </li>
        <li class="mobile-menu-item">
          <a href="../parking-history/parking-history.html" class="mobile-menu-link">
            <i class="fas fa-history"></i> Parking History
          </a>
        </li>
      </ul>

      <div class="mobile-menu-footer">
        <button id="logoutBtnMobile" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </div>

  <div id="notificationContainer" class="notification-container"></div>

  <main class="qr-scanner">
    <header class="page-header">
      <div>
        <h1 class="page-title">QR Code Scanner</h1>
        <p class="page-subtitle">Scan student QR codes for parking entry/exit</p>
      </div>
    </header>

    <div class="stats-cards">
      <div class="stat-card stat-card--parking">
        <div class="stat-icon">
          <i class="fas fa-parking"></i>
        </div>
        <div class="stat-content">
          <h3>Available Parking</h3>
          <p class="stat-value" id="availableSlotsStat">0</p>
        </div>
      </div>

      <div class="stat-card stat-card--occupied">
        <div class="stat-icon">
          <i class="fas fa-car"></i>
        </div>
        <div class="stat-content">
          <h3>Occupied Slots</h3>
          <p class="stat-value" id="occupiedSlotsStat">0</p>
        </div>
      </div>

      <div class="stat-card stat-card--scans">
        <div class="stat-icon">
          <i class="fas fa-qrcode"></i>
        </div>
        <div class="stat-content">
          <h3>Today's Scans</h3>
          <p class="stat-value" id="scanCountStat">0</p>
        </div>
      </div>
    </div>

    <div class="scanner-layout">
      <div class="scanner-container-card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-qrcode"></i> Scanner
          </h2>
        </div>

        <div class="scanner-display" id="scannerContainer">
          <div id="qr-reader"></div>
        </div>

        <div class="qr-attach-section" id="qrAttachSection">
          <div class="attach-icon">ðŸ“Ž</div>
          <div>Drag & drop QR image here</div>
          <div>or click to select file</div>
          <div style="font-size: 0.85rem; color: #666; margin-top: 5px">
            JPG, PNG, GIF
          </div>
        </div>

        <input type="file" id="fileInput" accept="image/*" />

        <div id="scannerMessage" class="scanner-status status-scanning">
          Ready to scan QR codes
        </div>

        <div class="scanner-controls">
          <button id="startScannerBtn" class="scanner-btn btn-primary">
            <i class="fas fa-play"></i> Start Scanner
          </button>
          <button id="stopScannerBtn" class="scanner-btn btn-secondary" disabled>
            <i class="fas fa-stop"></i> Stop Scanner
          </button>
        </div>
      </div>

      <div class="user-container-card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-user"></i> User Information
          </h2>
        </div>

        <div class="user-card" id="userCard">
          <div class="user-header">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-basic">
              <div class="user-name" id="userName">User Name</div>
              <div class="user-email" id="userEmail">user@email.com</div>
            </div>
            <div class="user-status status-approved" id="userStatus">
              Approved
            </div>
          </div>

          <div class="user-details-grid">
            <div class="detail-item">
              <div class="detail-label">Student ID</div>
              <div class="detail-value" id="studentId">N/A</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Contact</div>
              <div class="detail-value" id="userContact">N/A</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Course</div>
              <div class="detail-value" id="userCourse">N/A</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Year Level</div>
              <div class="detail-value" id="userYear">N/A</div>
            </div>
          </div>

          <div class="vehicle-card">
            <div class="vehicle-title">
              <i class="fas fa-motorcycle"></i> Vehicle Information
            </div>
            <div class="vehicle-info">
              <div>
                <div class="detail-label">Vehicle Type</div>
                <div class="detail-value" id="vehicleType">N/A</div>
              </div>
              <div>
                <div class="detail-label">Brand/Model</div>
                <div class="detail-value" id="vehicleModel">N/A</div>
              </div>
              <div>
                <div class="detail-label">Plate Number</div>
                <div class="detail-value" id="plateNumber">N/A</div>
              </div>
              <div>
                <div class="detail-label">Color</div>
                <div class="detail-value" id="vehicleColor">N/A</div>
              </div>
            </div>
          </div>

          <div class="action-buttons">
            <button id="entryBtn" class="action-btn btn-success">
              <i class="fas fa-sign-in-alt"></i> Allow Entry
            </button>
            <button id="exitBtn" class="action-btn btn-danger">
              <i class="fas fa-sign-out-alt"></i> Record Exit
            </button>
          </div>
        </div>

        <div class="parking-counter">
          <div class="counter-label">Available Parking Slots</div>
          <div class="counter-number" id="availableSlots">0</div>
          <div class="counter-total" id="totalSlots">/ 0</div>
        </div>

        <div class="parking-status-info">
          <div>
            <div class="occupied-count" id="occupiedSlots">0</div>
            <div class="parking-status-label">Occupied</div>
          </div>
          <div>
            <div class="occupied-count" id="availableSlotsCount">0</div>
            <div class="parking-status-label">Available</div>
          </div>
        </div>

        <div class="scan-counter" id="scanCounter">
          <div class="counter-number">0</div>
          <div class="counter-label">QR Codes Scanned Today</div>
        </div>

        <div class="loading" id="loadingIndicator">
          <div>Scan a QR code to display user information</div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDd4jxSZ1qDJmjiVeauuGuVFFImANRdeLo",
      authDomain: "parkqueue-216c7.firebaseapp.com",
      projectId: "parkqueue-216c7",
      storageBucket: "parkqueue-216c7.firebasestorage.app",
      messagingSenderId: "616114899392",
      appId: "1:616114899392:web:2c38883648cecd4f1c6025",
      measurementId: "G-WB0EN4W62V",
    };

    window.addEventListener("load", function () {
      firebase.initializeApp(firebaseConfig);

      const auth = firebase.auth();
      const db = firebase.firestore();
      const FieldValue = firebase.firestore.FieldValue;

      initializeScanner(auth, db, FieldValue);
    });

    function showNotification(title, message, type = "success", duration = 5000) {
      const container = document.getElementById("notificationContainer");
      if (!container) return;

      const notification = document.createElement("div");
      notification.className = `notification notification-${type}`;

      const iconMap = {
        success: "check-circle",
        error: "exclamation-circle",
        warning: "exclamation-triangle",
        info: "info-circle"
      };

      const icon = iconMap[type] || "info-circle";

      notification.innerHTML = `
        <div class="notification-content">
          <div class="notification-title">
            <i class="fas fa-${icon}"></i> ${title}
          </div>
          <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close">
          <i class="fas fa-times"></i>
        </button>
      `;

      container.appendChild(notification);

      const closeBtn = notification.querySelector(".notification-close");
      closeBtn.addEventListener("click", function () {
        notification.classList.add("hiding");
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      });

      if (duration > 0) {
        setTimeout(() => {
          if (notification.parentNode) {
            notification.classList.add("hiding");
            setTimeout(() => {
              if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
              }
            }, 300);
          }
        }, duration);
      }

      return notification;
    }

    function initializeScanner(auth, db, FieldValue) {
      let html5QrCode = null;
      let isScanning = false;
      let currentUser = null;
      let scanCount = 0;

      let availableSlots = 0;
      let totalSlots = 20;
      let occupiedSlots = 0;

      const startBtn = document.getElementById("startScannerBtn");
      const stopBtn = document.getElementById("stopScannerBtn");
      const statusEl = document.getElementById("scannerMessage");
      const logoutBtn = document.getElementById("logoutBtn");
      const userCard = document.getElementById("userCard");
      const loadingIndicator = document.getElementById("loadingIndicator");
      const fileInput = document.getElementById("fileInput");
      const qrAttachSection = document.getElementById("qrAttachSection");

      function updateDateDisplay() {
        const now = new Date();
        const options = {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        };
        document.getElementById("currentDate").textContent =
          now.toLocaleDateString('en-US', options);
      }

      updateDateDisplay();
      setInterval(updateDateDisplay, 60000);

      let authReady = false;
      auth.onAuthStateChanged(function (user) {
        if (!user) {
          window.location.href = "../login/admin-login.html";
          return;
        }

        authReady = true;

        document.getElementById("adminEmail").textContent = user.email;
        document.getElementById("adminName").textContent =
          user.displayName || "Admin";
        document.getElementById("mobileAdminEmail").textContent = user.email;
        document.getElementById("mobileAdminName").textContent =
          user.displayName || "Admin";
        document.getElementById("adminNameNav").textContent =
          user.displayName || "Admin";

        const initials = (user.displayName || user.email || "A")
          .charAt(0)
          .toUpperCase();
        document.getElementById("adminInitials").textContent = initials;
        document.getElementById("adminInitialsNav").textContent = initials;
        document.getElementById("mobileAdminInitials").textContent = initials;

        setTimeout(() => {
          initScanner();
          initializeFixedSlots();
          loadTodayScanCount();
          setupMobileMenu();
        }, 500);
      });

      function waitForAuth() {
        return new Promise((resolve) => {
          if (authReady) {
            resolve();
          } else {
            const unsubscribe = auth.onAuthStateChanged((user) => {
              if (user) {
                unsubscribe();
                resolve();
              }
            });
          }
        });
      }

      async function initializeFixedSlots() {
        try {
          const parkingSlotsQuery = await db.collection("parkingSlots").get();

          if (parkingSlotsQuery.empty) {
            const slots = [];
            const totalFixedSlots = 20;

            for (let i = 1; i <= totalFixedSlots; i++) {
              slots.push(
                db.collection("parkingSlots").add({
                  slotId: `SLOT_${i.toString().padStart(3, '0')}`,
                  slotNumber: i,
                  slotLabel: `Parking Slot ${i}`,
                  status: "available",
                  isFixed: true,
                  created_at: firebase.firestore.FieldValue.serverTimestamp()
                })
              );
            }

            await Promise.all(slots);
            totalSlots = totalFixedSlots;
          } else {
            totalSlots = parkingSlotsQuery.size;
          }

          loadParkingCounter();

        } catch (error) {
          console.error("Error initializing parking slots:", error);
        }
      }

      async function calculateParkingStats() {
        try {
          const parkingSlotsQuery = await db.collection("parkingSlots").get();

          if (parkingSlotsQuery.empty) {
            return {
              total: totalSlots,
              occupied: 0,
              available: totalSlots
            };
          }

          let occupied = 0;
          let total = 0;

          parkingSlotsQuery.forEach(doc => {
            const slotData = doc.data();
            total++;
            if (slotData.status === "occupied") {
              occupied++;
            }
          });

          if (total !== totalSlots) {
            totalSlots = total;
          }

          const available = Math.max(0, totalSlots - occupied);

          return {
            total: totalSlots,
            occupied: occupied,
            available: available
          };

        } catch (error) {
          console.error("Error calculating parking stats:", error);
          return {
            total: totalSlots,
            occupied: 0,
            available: totalSlots
          };
        }
      }

      async function loadParkingCounter() {
        try {
          const stats = await calculateParkingStats();

          occupiedSlots = stats.occupied;
          availableSlots = stats.available;

          updateParkingCounterUI();

          db.collection("parkingSlots").onSnapshot((snapshot) => {
            calculateParkingStats().then(newStats => {
              occupiedSlots = newStats.occupied;
              availableSlots = newStats.available;
              updateParkingCounterUI();
            });
          });

        } catch (error) {
          console.error("Error loading parking counter:", error);
          updateStatus("Failed to load parking counter", "error");
        }
      }

      function updateParkingCounterUI() {
        document.getElementById("availableSlots").textContent = availableSlots;
        document.getElementById("totalSlots").textContent = `/ ${totalSlots}`;
        document.getElementById("occupiedSlots").textContent = occupiedSlots;
        document.getElementById("availableSlotsCount").textContent = availableSlots;
        document.getElementById("availableSlotsStat").textContent = availableSlots;
        document.getElementById("occupiedSlotsStat").textContent = occupiedSlots;
        document.getElementById("availableSlotsNav").textContent = availableSlots;

        const availableSlotsEl = document.getElementById("availableSlots");
        const availableCountEl = document.getElementById("availableSlotsCount");
        const availableStatEl = document.getElementById("availableSlotsStat");

        if (totalSlots === 0) {
          availableSlotsEl.style.color = "#6c757d";
          availableCountEl.style.color = "#6c757d";
          availableStatEl.style.color = "#6c757d";
        } else if (availableSlots === 0) {
          availableSlotsEl.style.color = "#dc3545";
          availableCountEl.style.color = "#dc3545";
          availableStatEl.style.color = "#dc3545";
        } else if (availableSlots <= Math.floor(totalSlots * 0.2)) {
          availableSlotsEl.style.color = "#ff9800";
          availableCountEl.style.color = "#ff9800";
          availableStatEl.style.color = "#ff9800";
        } else {
          availableSlotsEl.style.color = "#1f8012";
          availableCountEl.style.color = "#1f8012";
          availableStatEl.style.color = "#1f8012";
        }
      }

      function initScanner() {
        try {
          if (typeof Html5Qrcode === "undefined") {
            throw new Error("QR Scanner library not loaded");
          }

          const scannerContainer =
            document.getElementById("scannerContainer");
          scannerContainer.innerHTML = '<div id="qr-reader"></div>';

          html5QrCode = new Html5Qrcode("qr-reader", {
            verbose: false,
            formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE],
          });

          startBtn.disabled = false;
          updateStatus(
            'Scanner ready. Click "Start Scanner" to begin.',
            "scanning"
          );
        } catch (error) {
          console.error("Scanner initialization error:", error);
          updateStatus("Scanner initialization failed", "error");
          startBtn.disabled = true;
        }
      }

      async function startScanner() {
        try {
          if (html5QrCode && isScanning) {
            await stopScanner();
          }

          clearUserDataUI();

          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: true,
            });
            window.stream = stream;
          } catch (error) {
            console.error("Camera permission error:", error);
            updateStatus(
              "Camera access denied. Please allow camera permissions.",
              "error"
            );
            showNotification(
              "Camera Access Required",
              "Please allow camera permissions in your browser settings and refresh the page.",
              "error",
              8000
            );
            return;
          }

          const qrboxFunction = function (viewfinderWidth, viewfinderHeight) {
            const minSize = Math.min(viewfinderWidth, viewfinderHeight);
            const size = Math.floor(minSize * 0.8);
            return {
              width: size,
              height: size,
            };
          };

          const config = {
            fps: 15,
            qrbox: qrboxFunction,
            aspectRatio: 1.0,
            disableFlip: false,
            experimentalFeatures: {
              useBarCodeDetectorIfSupported: true,
            },
          };

          try {
            await html5QrCode.start(
              { facingMode: "environment" },
              config,
              onScanSuccess,
              onScanError
            );
          } catch (backCameraError) {
            try {
              await html5QrCode.start(
                { facingMode: "user" },
                config,
                onScanSuccess,
                onScanError
              );
            } catch (frontCameraError) {
              console.error("All cameras failed:", frontCameraError);
              updateStatus(
                "Failed to access camera: " + frontCameraError.message,
                "error"
              );
              startBtn.disabled = false;
              stopBtn.disabled = true;
              return;
            }
          }

          isScanning = true;
          startBtn.disabled = true;
          stopBtn.disabled = false;
          updateStatus("Scanning... Point camera at QR code", "scanning");
        } catch (error) {
          console.error("Failed to start scanner:", error);
          updateStatus("Scanner error: " + error.message, "error");
          startBtn.disabled = false;
          stopBtn.disabled = true;
        }
      }

      async function stopScanner() {
        if (html5QrCode && isScanning) {
          try {
            await html5QrCode.stop();
            isScanning = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            updateStatus("Scanner stopped", "error");

            const scannerContainer =
              document.getElementById("scannerContainer");
            scannerContainer.innerHTML = '<div id="qr-reader"></div>';

            if (window.stream) {
              window.stream.getTracks().forEach(track => track.stop());
            }
          } catch (error) {
            console.error("Error stopping scanner:", error);
          }
        }
      }

      function onScanSuccess(decodedText, decodedResult) {
        if (isScanning) {
          updateStatus("QR detected! Processing...", "success");

          stopScanner();

          isScanning = false;

          processQRCode(decodedText).catch((error) => {
            console.error("Scan processing error:", error);
            updateStatus("Error: " + error.message, "error");
          });
        }
      }

      function onScanError(error) {
        console.debug("Scan error:", error);
      }

      function setupDragAndDrop() {
        const qrAttachSection = document.getElementById("qrAttachSection");

        qrAttachSection.addEventListener("click", function () {
          fileInput.click();
        });

        qrAttachSection.addEventListener("dragover", function (e) {
          e.preventDefault();
          e.stopPropagation();
          this.classList.add("drag-over");
        });

        qrAttachSection.addEventListener("dragleave", function (e) {
          e.preventDefault();
          e.stopPropagation();
          this.classList.remove("drag-over");
        });

        qrAttachSection.addEventListener("drop", function (e) {
          e.preventDefault();
          e.stopPropagation();
          this.classList.remove("drag-over");

          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleFileUpload({ target: { files: files } });
          }
        });

        fileInput.addEventListener("change", handleFileUpload);
      }

      async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.type.startsWith("image/")) {
          showNotification(
            "Invalid File",
            "Please select an image file (JPG, PNG, GIF)",
            "error",
            4000
          );
          return;
        }

        try {
          updateStatus("Reading QR from image...", "scanning");

          const fileScanner = new Html5Qrcode("qr-reader");

          const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            disableFlip: false,
          };

          const result = await fileScanner.scanFile(file, true);

          if (result) {
            console.log("QR detected from file:", result);
            await processQRCode(result);
            updateStatus("QR code processed from image", "success");
          } else {
            updateStatus("No QR code found in image", "error");
            showNotification(
              "QR Scan Failed",
              "No QR code was found in the uploaded image. Please ensure it's a clear QR code image.",
              "warning",
              5000
            );
          }
        } catch (error) {
          console.error("File scan error:", error);

          if (error.message.includes("No MultiFormat Readers")) {
            updateStatus(
              "Could not scan QR. Try taking a clearer picture or use camera scan.",
              "error"
            );
            showNotification(
              "QR Scanning Failed",
              "Please ensure:\n1. The QR code is clear and well-lit\n2. No glare on the QR code\n3. The entire QR code is visible\n\nTry using the camera scanner instead.",
              "warning",
              6000
            );
          } else {
            updateStatus("Error reading QR from image: " + error.message, "error");
          }
        }

        event.target.value = "";
      }

      async function processQRCode(decodedText) {
        console.log("Processing QR code:", decodedText);

        try {
          let userId = decodedText;

          console.log("Extracted user ID:", userId);

          if (!userId || userId.length < 10) {
            updateStatus("Invalid QR code format", "error");
            showNotification(
              "Invalid QR Code",
              "Could not extract user information from the scanned QR code.",
              "error",
              4000
            );
            return;
          }

          updateStatus("Searching for user...", "scanning");

          const userData = await fetchUserData(userId);

          if (userData) {
            currentUser = userData;

            const parkingStatus = await checkParkingStatusSimple(userData.id);
            userData.parkingStatus = parkingStatus;

            displayUserData(userData);
            userCard.style.display = "block";
            loadingIndicator.style.display = "none";

            const isNewScan = await shouldCountScanSimple(userData.id);
            if (isNewScan) {
              await incrementScanCount();
              updateStatus("User data loaded successfully", "success");
            } else {
              updateStatus("User data loaded (duplicate scan not counted)", "scanning");
            }

            playBeepSound();
          } else {
            updateStatus("User not found in database", "error");
            showNotification(
              "User Not Found",
              `User not found in the database.\nQR contained: ${userId}\n\nPlease check if:\n1. The user is registered\n2. The user is approved by admin\n3. The QR code is valid`,
              "error",
              6000
            );
          }
        } catch (error) {
          console.error("Process error:", error);
          updateStatus("Error: " + error.message, "error");
          showNotification(
            "Processing Error",
            "Error processing QR: " + error.message,
            "error",
            5000
          );
        }
      }

      async function checkParkingStatusSimple(userId) {
        try {
          const slotsQuery = await db.collection("parkingSlots")
            .where("user_id", "==", userId)
            .where("status", "==", "occupied")
            .get();

          if (!slotsQuery.empty) {
            const slotData = slotsQuery.docs[0].data();
            return {
              status: "active",
              lastAction: "entry",
              lastTime: slotData.entry_time ? slotData.entry_time.toDate() : new Date(),
              currentStatus: "in",
              slotData: slotData
            };
          }

          const historyQuery = await db.collection("parkingHistory")
            .where("user_id", "==", userId)
            .get();

          if (!historyQuery.empty) {
            let latestRecord = null;
            let latestTime = null;

            historyQuery.forEach(doc => {
              const data = doc.data();
              const recordTime = data.timestamp ? data.timestamp.toDate() : new Date(0);

              if (!latestTime || recordTime > latestTime) {
                latestTime = recordTime;
                latestRecord = data;
              }
            });

            if (latestRecord) {
              return {
                status: latestRecord.action === "entry" && latestRecord.status === "active" ? "active" : "inactive",
                lastAction: latestRecord.action,
                lastTime: latestTime,
                currentStatus: latestRecord.action === "entry" ? "in" : "out",
                record: latestRecord
              };
            }
          }

          return {
            status: "no_history",
            lastAction: null,
            lastTime: null,
            currentStatus: "out"
          };

        } catch (error) {
          console.error("Error checking parking status:", error);
          return {
            status: "error",
            lastAction: null,
            lastTime: null,
            currentStatus: "unknown"
          };
        }
      }

      async function shouldCountScanSimple(userId) {
        try {
          const today = new Date().toDateString();
          const todayScans = localStorage.getItem(`scannedToday_${today}`) || "{}";
          const scannedUsers = JSON.parse(todayScans);

          if (scannedUsers[userId]) {
            const lastScanTime = new Date(scannedUsers[userId]);
            const now = new Date();
            const timeDiff = (now - lastScanTime) / (1000 * 60);

            if (timeDiff < 5) {
              return false;
            }
          }

          scannedUsers[userId] = new Date().toISOString();
          localStorage.setItem(`scannedToday_${today}`, JSON.stringify(scannedUsers));
          return true;

        } catch (error) {
          console.error("Error checking recent scans:", error);
          return true;
        }
      }

      function playBeepSound() {
        try {
          const audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillator.frequency.value = 800;
          oscillator.type = "sine";
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            audioContext.currentTime + 0.1
          );

          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.1);
        } catch (e) {
          console.log("Audio not supported:", e);
        }
      }

      async function fetchUserData(userId) {
        try {
          console.log("Looking for user with ID:", userId);

          let userDoc = null;
          let userData = null;
          let userDocId = null;

          try {
            const docRef = db.collection("users").doc(userId);
            const docSnap = await docRef.get();
            if (docSnap.exists) {
              console.log("Found user by direct ID");
              userDoc = docSnap;
              userData = docSnap.data();
              userDocId = userId;
            }
          } catch (e) {
            console.log("Direct ID lookup failed:", e);
          }

          if (!userDoc) {
            console.log("Trying uid field search");
            const uidQuery = await db
              .collection("users")
              .where("uid", "==", userId)
              .limit(1)
              .get();

            if (!uidQuery.empty) {
              console.log("Found user by uid field");
              userDoc = uidQuery.docs[0];
              userData = userDoc.data();
              userDocId = userDoc.id;
            }
          }

          if (!userDoc && userId.includes("@")) {
            console.log("Trying email search");
            const emailQuery = await db
              .collection("users")
              .where("email", "==", userId.toLowerCase())
              .limit(1)
              .get();

            if (!emailQuery.empty) {
              console.log("Found user by email");
              userDoc = emailQuery.docs[0];
              userData = userDoc.data();
              userDocId = userDoc.id;
            }
          }

          if (!userDoc) {
            console.log("User not found with any method");
            return null;
          }

          console.log("User found, fetching additional data");

          const [personalInfo, vehicleInfo] = await Promise.all([
            fetchUserInfo("personalInfo", userDocId),
            fetchUserInfo("motorInfo", userDocId)
          ]);

          return {
            id: userDocId,
            data: userData,
            personal: personalInfo,
            vehicle: vehicleInfo,
            approved: userData.admin_approved === true,
          };
        } catch (error) {
          console.error("Fetch user error:", error);
          throw error;
        }
      }

      async function fetchUserInfo(collectionName, userId) {
        try {
          const query = await db
            .collection(collectionName)
            .where("user_id", "==", userId)
            .limit(1)
            .get();

          if (!query.empty) {
            return query.docs[0].data();
          }
          return {};
        } catch (error) {
          console.error(`Error fetching ${collectionName}:`, error);
          return {};
        }
      }

      function displayUserData(userData) {
        const name =
          `${userData.personal.first_name || ""} ${userData.personal.last_name || ""}`.trim() ||
          userData.data.displayName ||
          userData.data.username ||
          userData.data.email ||
          "Unknown User";

        document.getElementById("userName").textContent = name;
        document.getElementById("userEmail").textContent =
          userData.data.email || "No email";

        const firstChar = (
          userData.personal.first_name?.[0] ||
          userData.data.displayName?.[0] ||
          userData.data.username?.[0] ||
          userData.data.email?.[0] ||
          "U"
        ).toUpperCase();
        document.getElementById("userAvatar").textContent = firstChar;

        document.getElementById("userStatus").textContent = userData.approved
          ? "Approved"
          : "Pending";
        document.getElementById("userStatus").className = userData.approved
          ? "user-status status-approved"
          : "user-status status-pending";

        document.getElementById("studentId").textContent =
          userData.personal.student_id || "N/A";
        document.getElementById("userContact").textContent =
          userData.personal.contact_number || "N/A";
        document.getElementById("userCourse").textContent =
          userData.personal.course || "N/A";
        document.getElementById("userYear").textContent =
          userData.personal.year_level || "N/A";

        document.getElementById("vehicleType").textContent =
          userData.vehicle.vehicle_type || "N/A";
        document.getElementById("vehicleModel").textContent =
          `${userData.vehicle.brand || ""} ${userData.vehicle.model || ""}`.trim() || "N/A";
        document.getElementById("plateNumber").textContent =
          userData.vehicle.plate_number || "N/A";
        document.getElementById("vehicleColor").textContent =
          userData.vehicle.color || "N/A";

        updateParkingInfoUI(userData.parkingStatus);
      }

      function updateParkingInfoUI(parkingStatus) {
        const statusMap = {
          "active": {
            text: "Currently Checked In",
            color: "#1f8012",
            icon: "fa-sign-in-alt",
            buttonText: "Check Out",
            buttonClass: "btn-danger",
            buttonAction: "exit"
          },
          "inactive": {
            text: "Currently Checked Out",
            color: "#dc3545",
            icon: "fa-sign-out-alt",
            buttonText: "Check In",
            buttonClass: "btn-success",
            buttonAction: "entry"
          },
          "no_history": {
            text: "No Parking History",
            color: "#6c757d",
            icon: "fa-history",
            buttonText: "Check In",
            buttonClass: "btn-success",
            buttonAction: "entry"
          },
          "error": {
            text: "Status Error",
            color: "#dc3545",
            icon: "fa-exclamation-triangle",
            buttonText: "Unknown",
            buttonClass: "btn-secondary",
            buttonAction: null
          },
          "unknown": {
            text: "Unknown Status",
            color: "#6c757d",
            icon: "fa-question",
            buttonText: "Check Status",
            buttonClass: "btn-secondary",
            buttonAction: null
          }
        };

        const status = statusMap[parkingStatus.status] || statusMap["unknown"];

        const actionBtns = document.querySelector(".action-buttons");

        if (status.buttonAction === "entry") {
          actionBtns.innerHTML = `
        <button id="entryBtn" class="action-btn btn-success">
          <i class="fas fa-sign-in-alt"></i> ${status.buttonText}
        </button>
      `;
          const entryBtn = document.getElementById("entryBtn");
          entryBtn.addEventListener("click", handleEntry);
          entryBtn.disabled = !currentUser.approved;
        } else if (status.buttonAction === "exit") {
          actionBtns.innerHTML = `
        <button id="exitBtn" class="action-btn btn-danger">
          <i class="fas fa-sign-out-alt"></i> ${status.buttonText}
        </button>
      `;
          const exitBtn = document.getElementById("exitBtn");
          exitBtn.addEventListener("click", handleExit);
          exitBtn.disabled = !currentUser.approved;
        } else {
          actionBtns.innerHTML = `
        <button class="action-btn btn-secondary" disabled>
          <i class="fas ${status.icon}"></i> ${status.buttonText}
        </button>
      `;
        }

        let parkingInfo = document.getElementById("parkingInfo");
        if (!parkingInfo) {
          const vehicleCard = document.querySelector(".vehicle-card");
          parkingInfo = document.createElement("div");
          parkingInfo.className = "parking-info";
          parkingInfo.id = "parkingInfo";
          parkingInfo.style.cssText = `
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        border: 1px solid #dee2e6;
      `;
          vehicleCard.parentNode.insertBefore(parkingInfo, vehicleCard.nextSibling);
        }

        const lastTime = parkingStatus.lastTime ?
          parkingStatus.lastTime.toLocaleString() : "N/A";
        const lastAction = parkingStatus.lastAction ?
          parkingStatus.lastAction.toUpperCase() : "N/A";

        parkingInfo.innerHTML = `
      <div class="vehicle-title" style="font-size: 1rem; font-weight: 600; margin-bottom: 15px; color: #333;">
        <i class="fas fa-history"></i> Parking Status
      </div>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
        <div>
          <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px; font-weight: 500;">Current Status</div>
          <div style="font-weight: 500; color: ${status.color};" id="currentParkingStatus">${status.text}</div>
        </div>
        <div>
          <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px; font-weight: 500;">Last Action</div>
          <div style="font-weight: 500; color: #333;" id="lastParkingAction">${lastAction}</div>
        </div>
        <div>
          <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px; font-weight: 500;">Last Time</div>
          <div style="font-weight: 500; color: #333;" id="lastParkingTime">${lastTime}</div>
        </div>
      </div>
    `;
      }

      function clearUserDataUI() {
        currentUser = null;
        userCard.style.display = "none";
        loadingIndicator.style.display = "flex";

        document.getElementById("userName").textContent = "User Name";
        document.getElementById("userEmail").textContent = "user@email.com";
        document.getElementById("userAvatar").textContent = "U";
        document.getElementById("userStatus").textContent = "Approved";
        document.getElementById("userStatus").className = "user-status status-approved";
        document.getElementById("studentId").textContent = "N/A";
        document.getElementById("userContact").textContent = "N/A";
        document.getElementById("userCourse").textContent = "N/A";
        document.getElementById("userYear").textContent = "N/A";
        document.getElementById("vehicleType").textContent = "N/A";
        document.getElementById("vehicleModel").textContent = "N/A";
        document.getElementById("plateNumber").textContent = "N/A";
        document.getElementById("vehicleColor").textContent = "N/A";

        const parkingInfo = document.getElementById("parkingInfo");
        if (parkingInfo) {
          parkingInfo.style.display = "none";
        }

        const actionBtns = document.querySelector(".action-buttons");
        actionBtns.innerHTML = `
      <button id="entryBtn" class="action-btn btn-success">
        <i class="fas fa-sign-in-alt"></i> Check In
      </button>
      <button id="exitBtn" class="action-btn btn-danger">
        <i class="fas fa-sign-out-alt"></i> Check Out
      </button>
    `;
      }

      async function handleEntry() {
        if (!currentUser) return;

        try {
          if (availableSlots <= 0) {
            showNotification(
              "No Available Slots",
              "âŒ No available parking slots! Please wait for a slot to become available.",
              "error",
              5000
            );
            updateStatus("No available parking slots", "error");
            return;
          }

          const activeSessionQuery = await db.collection("parkingSlots")
            .where("user_id", "==", currentUser.id)
            .where("status", "==", "occupied")
            .limit(1)
            .get();

          if (!activeSessionQuery.empty) {
            showNotification(
              "Active Session Found",
              "âš ï¸ This user already has an active parking session!",
              "warning",
              5000
            );
            updateStatus("User already has active session", "error");
            return;
          }

          const availableSlotQuery = await db.collection("parkingSlots")
            .where("status", "==", "available")
            .limit(1)
            .get();

          if (availableSlotQuery.empty) {
            showNotification(
              "No Slots Available",
              "âŒ No available parking slots found in database!",
              "error",
              5000
            );
            updateStatus("No available slots found", "error");
            return;
          }

          const slotDoc = availableSlotQuery.docs[0];
          const slotDocId = slotDoc.id;
          const slotData = slotDoc.data();

          const personalInfo = currentUser.personal || {};

          await db.collection("parkingSlots").doc(slotDocId).update({
            status: "occupied",
            user_id: currentUser.id,
            user_email: currentUser.data.email || "",
            user_name: `${personalInfo.first_name || ""} ${personalInfo.last_name || ""}`.trim(),
            plate_number: currentUser.vehicle?.plate_number || "N/A",
            entry_time: firebase.firestore.FieldValue.serverTimestamp(),
            lastOccupiedAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastOccupiedBy: currentUser.id
          });

          const studentName = `${personalInfo.first_name || ""} ${personalInfo.last_name || ""}`.trim();
          const studentEmail = currentUser.data.email;
          const parkingSlot = slotData.slotId || `SLOT_${slotData.slotNumber || "01"}`;

          try {
            await sendParkingEmail(studentEmail, studentName, "entry", parkingSlot);
          } catch (emailError) {
            console.log("Email failed but parking recorded:", emailError);
          }

          await db.collection("parkingHistory").add({
            user_id: currentUser.id,
            user_email: currentUser.data.email || "",
            user_name: studentName,
            action: "entry",
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            processed_by: auth.currentUser.uid,
            admin_email: auth.currentUser.email,
            admin_name: document.getElementById("adminName").textContent,
            plate_number: currentUser.vehicle?.plate_number || "N/A",
            status: "active",
            parking_slot: parkingSlot,
            type: "parking",
            slot_document_id: slotDocId
          });

          updateStatus(`âœ“ Check-in recorded for ${currentUser.data.email}`, "success");

          const userFullName = `${currentUser.personal?.first_name || ""} ${currentUser.personal?.last_name || ""}`.trim();
          showNotification(
            "Check-in Successful",
            `âœ… Successfully checked in ${userFullName}\nParking Slot: ${parkingSlot}`,
            "success",
            5000
          );

          setTimeout(async () => {
            const stats = await calculateParkingStats();
            occupiedSlots = stats.occupied;
            availableSlots = stats.available;
            updateParkingCounterUI();
          }, 500);

          setTimeout(async () => {
            const parkingStatus = await checkParkingStatusSimple(currentUser.id);
            updateParkingInfoUI(parkingStatus);
          }, 1000);

        } catch (error) {
          console.error("Entry error:", error);
          updateStatus("Failed to record check-in", "error");
          showNotification(
            "Check-in Failed",
            "Error: " + error.message,
            "error",
            5000
          );
        }
      }

      async function handleExit() {
        if (!currentUser) return;

        try {
          const slotsQuery = await db.collection("parkingSlots")
            .where("user_id", "==", currentUser.id)
            .where("status", "==", "occupied")
            .limit(1)
            .get();

          if (slotsQuery.empty) {
            showNotification(
              "No Active Session",
              "âš ï¸ No active parking session found for this user!",
              "warning",
              5000
            );
            updateStatus("No active session found", "error");
            return;
          }

          const activeSlot = slotsQuery.docs[0];
          const slotData = activeSlot.data();

          await db.collection("parkingSlots").doc(activeSlot.id).update({
            status: "available",
            user_id: null,
            user_email: null,
            user_name: null,
            plate_number: null,
            exit_time: firebase.firestore.FieldValue.serverTimestamp(),
            lastOccupiedBy: currentUser.id,
            lastOccupiedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          await db.collection("parkingHistory").add({
            user_id: currentUser.id,
            user_email: currentUser.data.email || "",
            user_name: currentUser.personal?.first_name || "Unknown",
            action: "exit",
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            processed_by: auth.currentUser.uid,
            admin_email: auth.currentUser.email,
            admin_name: document.getElementById("adminName").textContent,
            plate_number: currentUser.vehicle?.plate_number || "N/A",
            status: "exited",
            parking_slot: slotData.slotId || "Unknown",
            type: "parking",
            entry_time: slotData.entry_time,
            exit_time: firebase.firestore.FieldValue.serverTimestamp(),
            duration_minutes: calculateDuration(slotData.entry_time),
            slot_document_id: activeSlot.id
          });

          updateStatus(
            `âœ“ Check-out recorded for ${currentUser.data.email}`,
            "success"
          );

          try {
            await sendParkingEmail(currentUser.data.email,
              `${currentUser.personal?.first_name || ""} ${currentUser.personal?.last_name || ""}`.trim(),
              "exit",
              slotData.slotId || "Unknown");
          } catch (emailError) {
            console.log("Exit email failed:", emailError);
          }

          const userFullName = `${currentUser.personal?.first_name || ""} ${currentUser.personal?.last_name || ""}`.trim();
          showNotification(
            "Check-out Successful",
            `âœ… Successfully checked out ${userFullName}\nParking Slot: ${slotData.slotId || "Unknown"}`,
            "success",
            5000
          );

          setTimeout(async () => {
            const stats = await calculateParkingStats();
            occupiedSlots = stats.occupied;
            availableSlots = stats.available;
            updateParkingCounterUI();
          }, 500);

          setTimeout(async () => {
            const parkingStatus = await checkParkingStatusSimple(currentUser.id);
            updateParkingInfoUI(parkingStatus);
          }, 1000);

        } catch (error) {
          console.error("Exit error:", error);
          updateStatus("Failed to record check-out: " + error.message, "error");
          showNotification(
            "Check-out Failed",
            "Error: " + error.message,
            "error",
            5000
          );
        }
      }

      function calculateDuration(entryTime) {
        if (!entryTime) return 0;

        try {
          const entryDate = entryTime.toDate ? entryTime.toDate() : new Date(entryTime);
          const exitDate = new Date();
          const durationMs = exitDate - entryDate;
          return Math.round(durationMs / (1000 * 60));
        } catch (e) {
          return 0;
        }
      }

      async function handleLogout() {
        const confirmed = await new Promise((resolve) => {
          const notification = showNotification(
            "Confirm Logout",
            "Are you sure you want to logout?",
            "info",
            0
          );

          const confirmDiv = document.createElement("div");
          confirmDiv.style.marginTop = "10px";
          confirmDiv.style.display = "flex";
          confirmDiv.style.gap = "10px";
          confirmDiv.style.justifyContent = "flex-end";

          const yesBtn = document.createElement("button");
          yesBtn.textContent = "Yes";
          yesBtn.style.padding = "5px 15px";
          yesBtn.style.background = "#1f8012";
          yesBtn.style.color = "white";
          yesBtn.style.border = "none";
          yesBtn.style.borderRadius = "4px";
          yesBtn.style.cursor = "pointer";

          const noBtn = document.createElement("button");
          noBtn.textContent = "No";
          noBtn.style.padding = "5px 15px";
          noBtn.style.background = "#6c757d";
          noBtn.style.color = "white";
          noBtn.style.border = "none";
          noBtn.style.borderRadius = "4px";
          noBtn.style.cursor = "pointer";

          confirmDiv.appendChild(yesBtn);
          confirmDiv.appendChild(noBtn);

          const contentDiv = notification.querySelector(".notification-content");
          contentDiv.appendChild(confirmDiv);

          yesBtn.addEventListener("click", () => {
            notification.classList.add("hiding");
            setTimeout(() => {
              if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
              }
            }, 300);
            resolve(true);
          });

          noBtn.addEventListener("click", () => {
            notification.classList.add("hiding");
            setTimeout(() => {
              if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
              }
            }, 300);
            resolve(false);
          });
        });

        if (confirmed) {
          await stopScanner();
          await auth.signOut();
          window.location.href = "../login/admin-login.html";
        }
      }

      function updateStatus(message, type) {
        if (statusEl) {
          statusEl.textContent = message;
          statusEl.className = `scanner-status status-${type}`;
        }
      }

      function resetScanner() {
        clearUserDataUI();
        updateStatus("Ready for next scan", "scanning");
      }

      async function incrementScanCount() {
        scanCount++;

        const todayCounter = document.querySelector(".scan-counter .counter-number");
        if (todayCounter) {
          todayCounter.textContent = scanCount;
        }

        document.getElementById("scanCountStat").textContent = scanCount;
        document.getElementById("scansCountNav").textContent = scanCount;

        const today = new Date().toDateString();
        localStorage.setItem(`scanCount_${today}`, scanCount);

        try {
          const adminId = auth.currentUser?.uid;

          if (adminId) {
            const todayKey = new Date().toISOString().split('T')[0];

            try {
              await db.collection("scanStats").doc(`${adminId}_${todayKey}`).set({
                admin_id: adminId,
                date: todayKey,
                count: scanCount,
                last_updated: firebase.firestore.FieldValue.serverTimestamp()
              }, { merge: true });
            } catch (firebaseError) {
            }
          }
        } catch (error) {
        }
      }
      async function loadTodayScanCount() {
        try {
          const adminId = auth.currentUser?.uid;
          const today = new Date().toDateString();
          const storedCount = localStorage.getItem(`scanCount_${today}`);

          if (storedCount) {
            scanCount = parseInt(storedCount) || 0;
          } else if (adminId) {
            const todayKey = new Date().toISOString().split('T')[0];
            try {
              const docRef = await db.collection("scanStats").doc(`${adminId}_${todayKey}`).get();
              if (docRef.exists) {
                scanCount = docRef.data().count || 0;
              }
            } catch (error) {
              scanCount = 0;
            }
          }

          const todayCounter = document.querySelector(".scan-counter .counter-number");
          if (todayCounter) {
            todayCounter.textContent = scanCount;
          }

          document.getElementById("scanCountStat").textContent = scanCount;
          document.getElementById("scansCountNav").textContent = scanCount;

        } catch (error) {
          console.error("Error loading scan count:", error);
          scanCount = 0;
          const todayCounter = document.querySelector(".scan-counter .counter-number");
          if (todayCounter) {
            todayCounter.textContent = "0";
          }
          document.getElementById("scanCountStat").textContent = "0";
          document.getElementById("scansCountNav").textContent = "0";
        }
      }

      function setupMobileMenu() {
        const menuToggle = document.getElementById("menuToggle");
        const mobileMenu = document.getElementById("mobileMenu");
        const closeMenu = document.getElementById("closeMenu");
        const logoutBtnMobile = document.getElementById("logoutBtnMobile");

        if (menuToggle) {
          menuToggle.addEventListener("click", function () {
            mobileMenu.style.display = "block";
            setTimeout(() => {
              mobileMenu.classList.add("show");
            }, 10);
          });
        }

        if (closeMenu) {
          closeMenu.addEventListener("click", function () {
            mobileMenu.classList.remove("show");
            setTimeout(() => {
              mobileMenu.style.display = "none";
            }, 300);
          });
        }

        if (logoutBtnMobile) {
          logoutBtnMobile.addEventListener("click", handleLogout);
        }

        mobileMenu.addEventListener("click", function (e) {
          if (e.target === mobileMenu) {
            mobileMenu.classList.remove("show");
            setTimeout(() => {
              mobileMenu.style.display = "none";
            }, 300);
          }
        });
      }

      function setupEventListeners() {
        startBtn.addEventListener("click", startScanner);
        stopBtn.addEventListener("click", stopScanner);
        logoutBtn.addEventListener("click", handleLogout);

        setupDragAndDrop();

        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            resetScanner();
          }
          if (e.key === "s" || e.key === "S") {
            if (!isScanning) {
              startScanner();
            }
          }
        });

        document.addEventListener("click", function (e) {
          if (e.target === document.body || e.target.classList.contains("scanner-display")) {
            resetScanner();
          }
        });
      }

      setTimeout(() => {
        setupEventListeners();
      }, 1000);

      window.addEventListener("beforeunload", function () {
        if (html5QrCode && isScanning) {
          html5QrCode.stop();
        }
      });

      function checkForNewDay() {
        const today = new Date().toDateString();
        const lastDate = localStorage.getItem("lastScanDate");

        if (lastDate !== today) {
          localStorage.setItem("lastScanDate", today);
          scanCount = 0;
          const todayCounter = document.querySelector(".scan-counter .counter-number");
          if (todayCounter) {
            todayCounter.textContent = "0";
          }
          document.getElementById("scanCountStat").textContent = "0";
          document.getElementById("scansCountNav").textContent = "0";
        }
      }

      setInterval(checkForNewDay, 60000);
      checkForNewDay();
    }

    async function sendParkingEmail(studentEmail, studentName, action, parkingSlot = null) {
      try {
        console.log("ðŸ“§ Attempting to send parking email...");
        console.log("To:", studentEmail);
        console.log("Name:", studentName);
        console.log("Action:", action);
        console.log("Slot:", parkingSlot);

        await new Promise(resolve => setTimeout(resolve, 100));

        const emailResponse = await fetch('http://localhost:3000/api/send-parking-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            studentEmail: studentEmail,
            studentName: studentName,
            action: action,
            parkingSlot: parkingSlot || getAvailableParkingSlotNumber(),
            scannerLocation: 'School Parking Area',
            timestamp: new Date().toISOString()
          })
        });


        if (!emailResponse.ok) {
          console.warn("âš ï¸ Email server responded with status:", emailResponse.status);

          return false;
        }

        const result = await emailResponse.json();
        console.log("ðŸ“§ Email API response:", result);

        if (result.success) {
          console.log("âœ… Email sent successfully!");
          return true;
        } else {
          console.warn("âš ï¸ Email sending failed:", result.message);
          return false;
        }

      } catch (error) {
        console.error("âŒ Email fetch error:", error);
        console.log("â„¹ï¸ Parking action was still recorded successfully");

        return false;
      }
    }


    function getAvailableParkingSlotNumber() {
      const occupied = parseInt(document.getElementById("occupiedSlots").textContent) || 0;
      const total = parseInt(document.getElementById("totalSlots").textContent.replace('/', '')) || 20;
      const slotNumber = occupied + 1;
      return `A-${String(slotNumber).padStart(2, '0')}`;
    }
  </script>
</body>

</html>